(function(){Vue.component("convos-connection-settings",{props:["connection","user"],data:function(){return{advancedSettings:false,errors:[],url:{query:{nick:""}},nick:"",onConnectCommands:"",server:"",tls:null,password:"",username:"",wantedState:""};},watch:{advancedSettings:function(v,o){if(v)autosize(this.$refs.occ.$els.input);},connection:function(v,o){this.updateForm();}},methods:{humanState:function(){if(this.connection.state=='queued')return'Connecting...';if(this.connection.getDialog("").frozen)return this.connection.getDialog("").frozen;return'State: '+this.connection.state.ucFirst();},removeConnection:function(){var self=this;this.connection.remove(function(err){if(err)return self.errors=err;self.settings.main="#connection";});},saveConnection:function(){var self=this;var connection=this.connection||new Convos.Connection({user:this.user});var params=[];var userinfo;userinfo=[this.username,this.password].map(function(str){return encodeURIComponent(str)}).join(":");userinfo=userinfo.match(/[^:]/)?userinfo+"@":"";connection.user=this.user;connection.wantedState=this.wantedState;connection.url="irc://"+userinfo+this.server;connection.on_connect_commands=this.onConnectCommands.split(/\n/).map(function(str){return str.trim();});if(this.nick)params.push("nick="+this.nick);if(this.tls!==null)params.push("tls="+(this.tls?1:0));if(params.length)connection.url+="?"+params.join("&");this.errors=[];connection.save(function(err){if(err)return self.errors=err;self.deleted=false;self.updateForm(this);this.user.ensureDialog({connection_id:this.connection_id,dialog_id:"",name:this.connection_id});self.settings.main=this.connection?"#chat/"+this.connection_id+"/":"#create-dialog";});},updateForm:function(){var nick=this.user.email.split("@")[0].replace(/\W+/g,"_");var url=this.connection?this.connection.url.parseUrl():null;var userinfo=url?url.userinfo:[];this.wantedState=this.connection?this.connection.wantedState:"connect";this.errors=[];this.url=url||{query:{nick:""}};this.nick=url?url.query.nick||nick:nick;this.onConnectCommands=url?this.connection.on_connect_commands.join("\n"):"";this.server=url?url.hostPort:this.settings.default_server||"";this.tls=url?url.query.tls!=false:null;this.password="";this.username=decodeURIComponent(userinfo[0]||"");}},ready:function(){this.updateForm();},template:"<form @submit.prevent autocomplete=\"off\" class=\"content\">\n    <div class=\"row\" v-if=\"connection\">\n      <div class=\"col s12\">\n        <h5>Edit {{connection.name}}</h5>\n      </div>\n    </div>\n    <template v-if=\"connection\">\n      <div class=\"row\">\n        <md-input :placeholder=\"url.hostPort\" :readonly=\"settings.forced_irc_server\" :value.sync=\"server\" cols=\"s12\">Server</md-input>\n      </div>\n      <div class=\"row\" v-if=\"connection\">\n        <md-select :value.sync=\"wantedState\" label=\"State\">\n          <md-option :selected=\"&#39;connected&#39; == connection.state\" value=\"connect\">Connected</md-option>\n          <md-option :selected=\"&#39;disconnected&#39; == connection.state\" value=\"disconnect\">Disconnected</md-option>\n        </md-select>\n      </div>\n      <div class=\"row\">\n        <md-input :placeholder=\"url.query.nick\" :value.sync=\"nick\">Nick</md-input>\n      </div>\n      <div class=\"row\">\n        <div class=\"col s12\">\n          <input class=\"filled-in\" id=\"form_tls\" type=\"checkbox\" v-model=\"tls\">\n          <label for=\"form_tls\">Secure connection (TLS)</label>\n        </div>\n      </div>\n    </template>\n    <template v-if=\"!connection\">\n      <div class=\"row\">\n        <md-input :readonly=\"settings.forced_irc_server\" :value.sync=\"server\" cols=\"s6\" focus=\"true\" placeholder=\"Example: chat.freenode.net:6697\">Server</md-input>\n        <md-input :value.sync=\"nick\" cols=\"s6\" placeholder=\"Example: jan_henning\">Nick</md-input>\n      </div>\n    </template>\n    <div class=\"row\">\n      <div class=\"col s12\">\n        <input class=\"filled-in\" id=\"form_advanced_settings\" type=\"checkbox\" v-model=\"advancedSettings\">\n        <label for=\"form_advanced_settings\">Advanced settings...</label>\n      </div>\n    </div>\n    <template v-if=\"advancedSettings\">\n      <div class=\"row\">\n        <md-input :value.sync=\"username\" cols=\"s6\">Username</md-input>\n        <md-input :value.sync=\"password\" cols=\"s6\" type=\"password\">Password</md-input>\n      </div>\n      <div class=\"row on-connect-commands\">\n        <md-textarea :value.sync=\"onConnectCommands\" placeholder=\"/msg NickServ identify supersecret\" v-ref:occ>On Connect Commands (one per line)</md-textarea>\n      </div>\n    </template>\n    <div class=\"row\" v-if=\"errors.length\">\n      <div class=\"col s12\"><div class=\"alert\">{{errors[0].message}}</div></div>\n    </div>\n    <div class=\"row\">\n      <div class=\"col s12\">\n        <button @click=\"saveConnection\" class=\"btn waves-effect waves-light\">{{connection ? &quot;Save&quot; : &quot;Create&quot;}}</button>\n        <a @click.prevent=\"removeConnection\" class=\"btn-delete\" href=\"#delete\" v-if=\"connection\">Delete</a>\n        <p v-if=\"connection\">{{humanState()}}</p>\n      </div>\n    </div>\n  </form>\n"})})();